apiVersion: v1
kind: Secret
metadata:
  name: orders-mongo-secret
type: Opaque
stringData:
  MONGO_INITDB_ROOT_USERNAME: "root"
  MONGO_INITDB_ROOT_PASSWORD: "example"
  MONGO_INITDB_DATABASE: "mongodb"

---
apiVersion: v1
kind: Secret
metadata:
  name: orders-mongo-keyfile
type: Opaque
data:
  keyfile: "<base64-encoded-key-here>"  # Replace with your actual base64-encoded keyfile content (e.g., generated via: openssl rand -base64 756 | base64 -w 0)

---
apiVersion: v1
kind: Service
metadata:
  name: orders-mongo
spec:
  selector:
    app: orders-mongo
  ports:
  - protocol: TCP
    port: 27017
    targetPort: 27017
  type: ClusterIP

---
apiVersion: v1
kind: Service
metadata:
  name: orders-mongo-headless
spec:
  clusterIP: None
  selector:
    app: orders-mongo
  ports:
  - protocol: TCP
    port: 27017
    targetPort: 27017

---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: orders-mongo
spec:
  serviceName: orders-mongo-headless
  replicas: 1
  selector:
    matchLabels:
      app: orders-mongo
  template:
    metadata:
      labels:
        app: orders-mongo
    spec:
      containers:
      - name: mongo
        image: mongo:latest
        command:
        - mongod
        - "--replSet"
        - "rs0"
        - "--auth"
        - "--keyFile"
        - "/etc/mongo-keyfile/keyfile"
        envFrom:
          - secretRef:
              name: orders-mongo-secret
        ports:
        - containerPort: 27017
        volumeMounts:
        - name: data
          mountPath: /data/db
        - name: keyfile
          mountPath: /etc/mongo-keyfile
        readinessProbe:
          exec:
            command:
            - /bin/sh
            - -c
            - 'mongosh --username "$MONGO_INITDB_ROOT_USERNAME" --password "$MONGO_INITDB_ROOT_PASSWORD" --authenticationDatabase admin --eval "db.adminCommand(''ping'')"'
          initialDelaySeconds: 15
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 5
        livenessProbe:
          exec:
            command:
            - /bin/sh
            - -c
            - 'mongosh --username "$MONGO_INITDB_ROOT_USERNAME" --password "$MONGO_INITDB_ROOT_PASSWORD" --authenticationDatabase admin --eval "db.adminCommand(''ping'')"'
          initialDelaySeconds: 15
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 5
        lifecycle:
          postStart:
            exec:
              command:
              - /bin/sh
              - -c
              - |
                until mongosh --username "$MONGO_INITDB_ROOT_USERNAME" --password "$MONGO_INITDB_ROOT_PASSWORD" --authenticationDatabase admin --eval "db.adminCommand('ping')" > /dev/null 2>&1; do
                  sleep 2
                done
                mongosh --username "$MONGO_INITDB_ROOT_USERNAME" --password "$MONGO_INITDB_ROOT_PASSWORD" --authenticationDatabase admin --eval "
                try {
                  rs.status();
                } catch (e) {
                  rs.initiate({
                    _id: 'rs0',
                    members: [
                      { _id: 0, host: 'orders-mongo-0.orders-mongo-headless:27017' }
                    ]
                  })
                }"
      volumes:
      - name: keyfile
        secret:
          secretName: orders-mongo-keyfile
          defaultMode: 0400
          items:
          - key: keyfile
            path: keyfile
            mode: 0400
  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      storageClassName: standard
      accessModes: ["ReadWriteOnce"]
      resources:
        requests:
          storage: 10Gi